# group: [gaggle]

# Test suite for Gaggle extension integration scenarios
# Tests realistic usage patterns and workflows

statement ok
pragma enable_verification

# Load the Gaggle extension
statement ok
load 'build/release/extension/gaggle/gaggle.duckdb_extension'

# Test 1: Basic workflow - set credentials, get version, check cache
statement ok
select gaggle_set_credentials('kaggle_user', 'kaggle_key')

query I
select gaggle_get_version() != ''
----
1

query I
select gaggle_get_cache_info() != ''
----
1

# Test 2: Repeated operations should be idempotent
statement ok
select gaggle_clear_cache()

statement ok
select gaggle_clear_cache()

statement ok
select gaggle_get_cache_info()

# Test 3: Credentials can be updated in sequence
statement ok
select gaggle_set_credentials('user1', 'key1')

statement ok
select gaggle_set_credentials('user2', 'key2')

statement ok
select gaggle_set_credentials('user3', 'key3')

# Test 4: Cache operations are safe
statement ok
begin transaction

statement ok
select gaggle_clear_cache()

statement ok
select gaggle_get_cache_info()

statement ok
commit

# Test 5: Multiple calls within aggregation context
query I
select count(*) filter (where gaggle_clear_cache() = 1)
----
1

# Test 6: Verify functions work in WHERE clause context
query I
select gaggle_get_version() is not null
  and gaggle_get_cache_info() is not null
----
1

# Test 7: Functions in SELECT with other expressions
query T
select 'Gaggle_' || substring(gaggle_get_version(), 1, 10)
----
Gaggle_{"name":"G

# Test 8: Version should remain consistent across calls
query I
select gaggle_get_version() = gaggle_get_version()
----
1
